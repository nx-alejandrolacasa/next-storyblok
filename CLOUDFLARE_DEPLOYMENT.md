# Cloudflare Pages Deployment Guide

This Next.js application is configured to deploy to Cloudflare Pages using the `@opennextjs/cloudflare` adapter.

## Prerequisites

- A Cloudflare account
- Your repository connected to Cloudflare Pages
- Storyblok API token (for environment variables)

## Cloudflare Pages Configuration

In your Cloudflare Pages project settings, configure the following:

### Build Configuration

| Setting | Value |
|---------|-------|
| **Framework preset** | None |
| **Build command** | `npm run pages:build` |
| **Build output directory** | `.open-next/worker` |
| **Root directory** | `/` (leave as default) |

### Important: Remove Deploy Command

**DO NOT** configure a custom deploy command. Cloudflare Pages will automatically handle deployment after the build completes.

If you previously had `npx wrangler deploy` or `npx wrangler versions upload` configured as a deploy command, **remove it**.

### Environment Variables

Add the following environment variables in your Cloudflare Pages project settings:

| Variable | Value | Notes |
|----------|-------|-------|
| `STORYBLOK_TOKEN` | Your Storyblok API token | Required for content fetching |
| `STORYBLOK_SPACE` | Your Storyblok space ID | Required for Storyblok integration |
| `NODE_VERSION` | `22` | Optional, matches build environment |

## How It Works

1. **Build Process**:
   - `npm run pages:build` runs `@opennextjs/cloudflare build`
   - This first builds your Next.js app with `next build`
   - Then transforms the output into a Cloudflare Worker format
   - Output is generated in `.open-next/worker.js`

2. **Deployment**:
   - Cloudflare Pages automatically deploys the built worker
   - No manual wrangler commands needed
   - Assets and functions are deployed to Cloudflare's edge network

## Local Development

### Standard Next.js Development
```bash
npm run dev
```

### Preview with Cloudflare Worker Runtime
```bash
# First build for Cloudflare
npm run pages:build

# Then preview locally with Wrangler
npm run pages:dev
```

## Manual Deployment (Optional)

If you need to deploy manually from your local machine:

```bash
# Build for Cloudflare
npm run pages:build

# Deploy to Cloudflare Workers
npm run pages:deploy
```

Note: Manual deployment requires Wrangler authentication (`npx wrangler login`)

## Troubleshooting

### Build Fails with "Missing entry-point"

This means the OpenNext build didn't complete successfully. The `.open-next/worker.js` file should exist after a successful build.

**Solution**: Ensure your build command is `npm run pages:build`, not just `npm run build`.

### Deploy Command Fails

**Solution**: Remove any custom deploy command from Cloudflare Pages settings. Let Cloudflare handle deployment automatically.

### "npm ci" Fails with Lock File Errors

**Solution**: Ensure your `package-lock.json` is committed and up to date.

### Storyblok API Token Warning

This is normal during build if the environment variable isn't set. Make sure `STORYBLOK_TOKEN` is configured in Cloudflare Pages environment variables.

### Next.js 16 Compatibility Warning

OpenNext currently shows a warning that Next.js 16 is not fully supported. Most features work, but if you encounter issues, consider downgrading to Next.js 15:

```bash
npm install next@15.5.2 --save-exact
```

## Project Structure

```
.
├── .open-next/          # Generated by OpenNext (git-ignored)
│   ├── worker.js        # Main Cloudflare Worker file
│   ├── assets/          # Static assets
│   ├── cache/           # Cache handlers
│   └── ...
├── middleware.ts        # Edge middleware (i18n routing)
├── open-next.config.ts  # OpenNext configuration
├── wrangler.toml        # Cloudflare Worker config (for local dev)
└── ...
```

## Additional Resources

- [OpenNext Cloudflare Documentation](https://opennext.js.org/cloudflare)
- [Cloudflare Pages Documentation](https://developers.cloudflare.com/pages/)
- [Next.js on Cloudflare](https://developers.cloudflare.com/pages/framework-guides/nextjs/)
